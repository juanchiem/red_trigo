[["4-meteo.html", "4 Condiciones meteorológicas 4.1 Precipitaciones 4.2 Temperaturas", " 4 Condiciones meteorológicas 4.1 Precipitaciones pacman::p_load(tidyverse, lubridate) load(&quot;data/nova_trigo.Rdata&quot;) source(here::here(&#39;0 themes.R&#39;)) 4.1.1 Cálculos resumen y visualización gráfica de las precipitaciones acumuladas por década 1- Importar datos y agregar algunas columnas de fechas serie &lt;- serie %&gt;% mutate(year = lubridate::year(date), month = lubridate::month(date), julian = lubridate::yday(date)) 2 - Calcular lluvias acumuladas por década serie20 &lt;- serie %&gt;% filter(year!=2020) %&gt;% group_by(date=if_else(day(date) &gt;= 30, floor_date(date, &quot;20 days&quot;), floor_date(date, &quot;10 days&quot;))) %&gt;% summarize(rain_acum = sum(rain), days = n()) %&gt;% mutate(year = year(date), month = month(date)) %&gt;% ungroup %&gt;% group_by(year) %&gt;% mutate(decada = row_number()) %&gt;% ungroup %&gt;% group_by(decada) %&gt;% summarise(month = first(month), med = quantile(rain_acum, .5, na.rm = T), lower_80=quantile(rain_acum, .2, na.rm = T), # Rango 80% de los años upper_80=quantile(rain_acum, .8, na.rm = T)) serie20 ## # A tibble: 36 x 5 ## decada month med lower_80 upper_80 ## &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 1 1 14.1 7.1 34.4 ## 2 2 1 12.8 3.6 55.6 ## 3 3 1 50.8 16.0 70.2 ## 4 4 2 20.2 12.6 60. ## 5 5 2 23.8 2.36 46.3 ## 6 6 2 20.8 1.5 56.5 ## 7 7 3 35.3 15.1 70.2 ## 8 8 3 27.6 16.8 55.3 ## 9 9 3 8.45 2.44 33.9 ## 10 10 4 17.8 3.4 48.3 ## # … with 26 more rows c2020 &lt;- # Para la reciente campaña serie %&gt;% group_by(date = if_else(day(date) &gt;= 30, floor_date(date, &quot;20 days&quot;), floor_date(date, &quot;10 days&quot;))) %&gt;% summarize(rain_acum_season = sum(rain)) %&gt;% #, days=n()) %&gt;% mutate(year = year(date), month = month(date)) %&gt;% group_by(year) %&gt;% mutate(decada = row_number()) %&gt;% filter(date &gt; &#39;2020-05-01&#39;, date &lt; &#39;2020-12-31&#39;) c2020 &lt;- # fusionar ambos datasets (serie + campaña) c2020 %&gt;% left_join(serie20, by = c(&quot;decada&quot;)) %&gt;% mutate(date = as.Date(date)) # print(bce_18_19, n=Inf) # Check # print(bce_serie, n=Inf) # Check 3 - Visualizar la serie y sus bandas de 80-percentil, y valores acumulados por década de la última campaña c2020 %&gt;% ggplot(aes(x=date)) + geom_pointrange(aes(y=med, ymin=lower_80, ymax=upper_80), fill=&#39;white&#39;, color=&#39;deepskyblue&#39;, shape=21, fatten=.7, size=3, position=(p5=position_nudge(x = 5)))+ geom_point(aes(y=rain_acum_season), col =&quot;brown1&quot;, position=p5) + geom_line(aes(y=rain_acum_season, group=1), col =&quot;brown1&quot;, linetype=&quot;dashed&quot;, position=p5)+ # scale_y_continuous(limits=c(0, 100), expand=c(0.05, 0))+ scale_x_date(date_breaks=&quot;1 month&quot;, date_labels=&quot;%b&quot;, expand=expansion(0.05,0))+ labs(x=NULL, y=NULL, title = &quot;Precipitaciones decádicas en Balcarce&quot;, subtitle = &quot;- Campaña 2020 (en puntos rojos)\\n- Serie 2000-2019: mediana (puntos blancos) y rango 80% (barras azules)&quot;, # &quot;mm acumulados por períodos de 10 días&quot;, caption = &quot;Datos registrados en la estación meteorológica de la EEA INTA Balcarce&quot;) # serie %&gt;% # filter(year &lt;2020) %&gt;% # group_by(year) %&gt;% # summarise(cs = cumsum(rain)) c2020 %&gt;% mutate_at(vars(month.y), as.factor)%&gt;% ungroup() %&gt;% group_by(month.y) %&gt;% summarise( cs = sum(rain_acum_season), cs_med = sum(med)) ## # A tibble: 8 x 3 ## month.y cs cs_med ## &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 5 52 24.7 ## 2 6 80.5 28.4 ## 3 7 49.7 36.2 ## 4 8 15 27.6 ## 5 9 41.5 48.6 ## 6 10 118. 61.7 ## 7 11 19.8 66 ## 8 12 30.8 60.6 # 5 - Fenología del cultivo # z39 = c(as.Date(&quot;2018-12-15&quot;), as.Date(&quot;2019-01-15&quot;)); diff(r5) # r6 = c(as.Date(&quot;2019-01-15&quot;), as.Date(&quot;2019-03-10&quot;)); diff(r6) # midpoint &lt;- function(interval) { min(interval)+(max(interval)-min(interval))/2 }; midpoint(r5) # (p_final &lt;- # Agregar fenología y anotaciones varias # p1 + # # Polígonos de floracion y llenado # annotate(&quot;rect&quot;, xmin= c(min(r5), min(r6)), xmax=c(max(r5),max(r6)), ymin=70, ymax=90, alpha=0.3, fill=c(&quot;grey80&quot;,&quot;grey60&quot;))+ # annotate(&quot;text&quot;, x = c(midpoint(r5), midpoint(r6)), y=80,col=&quot;red&quot;, parse=TRUE, size=3, # label=c(&#39;bold(&quot;Floración&quot;)&#39;,&#39;bold(&quot;Llenado&quot;)&#39;)) + # labs(x=NULL, y=NULL, # title = &quot;Precipitaciones decádicas en Balcarce y estadíos reproductivos del girasol&quot;, # subtitle = &quot;- Campaña 2018/19 (en puntos rojos)\\n- Serie 1971-2017: mediana (puntos blancos) y rango 80% (barras azules)&quot;, # # &quot;mm acumulados por períodos de 10 días&quot;, # caption = &quot;Datos registrados en la estación meteorológica de la EEA INTA Balcarce&quot;) # ) # ggsave(file = &quot;plots/bce_lluvias.png&quot;, w=80, h=50, units=&quot;mm&quot;, dpi=300, scale=2) 4.2 Temperaturas 4.2.1 Calcular 80-percentil de Tmean diarias y valores maximos y minimos observados en la serie histórica bce_serie &lt;- serie %&gt;% filter(year!=2020) %&gt;% group_by(julian) %&gt;% summarise( month = first(month), avg = mean(tmean, .2, na.rm = T), # Rango 80% de los años (rango interno) lower_80=quantile(tmean, .2, na.rm = T), upper_80=quantile(tmean, .8, na.rm = T), # Min y max de tmean (rango externo) lower_tmean=min(tmean, na.rm = T), upper_tmean=max(tmean, na.rm = T)) %&gt;% ungroup() camp &lt;- # Fusionar serie con campaña 18/19 serie %&gt;% filter(date &gt; &#39;2020-05-01&#39;, date &lt; &#39;2020-12-30&#39;) %&gt;% left_join(bce_serie, by = c(&quot;julian&quot;, &quot;month&quot;)) %&gt;% mutate(date = as.Date(date)) %&gt;% droplevels() camp %&gt;% group_by(month) %&gt;% summarize(n_days = n(), d_frios = sum(tmean &lt; avg), p_frios = d_frios / n_days, d_calidos = sum(tmean &gt; avg), p_calidos = d_calidos / n_days ) ## # A tibble: 8 x 6 ## month n_days d_frios p_frios d_calidos p_calidos ## &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; ## 1 5 30 13 0.433 17 0.567 ## 2 6 30 14 0.467 16 0.533 ## 3 7 31 23 0.742 8 0.258 ## 4 8 31 17 0.548 14 0.452 ## 5 9 30 18 0.6 12 0.4 ## 6 10 31 19 0.613 12 0.387 ## 7 11 30 9 0.3 21 0.7 ## 8 12 30 15 0.5 15 0.5 camp %&gt;% ggplot(aes(date, avg)) + geom_ribbon(aes(ymin = tmean, ymax = pmin(tmean, avg), fill = &quot;cálido&quot;),alpha=0.5 ) + geom_ribbon(aes(ymin = avg, ymax = pmin(tmean, avg), fill = &quot;frío&quot;), alpha=0.5) + geom_line(aes(date, avg, linetype = &quot;media 2000-2019 &quot;)) + geom_line(aes(date, tmean, linetype = &quot;campaña 2020&quot;)) + scale_fill_brewer(palette = &quot;Set1&quot;, direction = 1)+ scale_x_date(date_breaks=&quot;1 month&quot;, date_labels=&quot;%b&quot;, expand=expansion(0.01,0))+ labs(fill=&quot;&quot;, linetype=&quot;&quot;, x =&quot;&quot;, y =&quot;T°&quot;)+ theme_dens rec_frio &lt;- camp[which(camp$tmean&lt;camp$lower_tmean),] rec_cal &lt;- camp[which(camp$tmean&gt;camp$upper_tmean),] library(ggrepel); options(repr.plot.width = 2, repr.plot.height = 2) p2 &lt;- p1 + # Agregar medias record frío geom_point(data = rec_frio, aes(date, y = tmean), colour = &quot;blue&quot;) + geom_text_repel(data=rec_frio[1,], aes(y=tmean, label=&quot;Récord fríos&quot;), size=3, min.segment.length = unit(0, &#39;lines&#39;), nudge_y = -2, segment.color=&quot;grey50&quot;)+ # Agregar medias record cálido geom_point(data =rec_cal, aes(date, y=tmean), col=&quot;red&quot;)+ geom_text_repel(data = rec_cal, aes(y=tmean, label=&quot;Récord cálido&quot;), size=3, min.segment.length = unit(0, &#39;lines&#39;), nudge_y=2, segment.color=&quot;grey50&quot;)+ # Agregar heladas meteorologicas y agronomicas geom_point(data = camp[which(camp$tmin&lt;1),], aes(date, y=0), shape=8, col=&quot;blue&quot;) + geom_point(data = camp[which(camp$tmin&gt;0 &amp; camp$tmin&lt;3.6),], aes(date, y=3.5), shape=8, col=&quot;chartreuse&quot;)#+ p2 # annotate(&quot;text&quot;, x=-Inf, y=c(0,3.5), # label=c(&quot;Helada meteorológica&quot;,&quot;Heladas\\nagronómicas&quot;), size=3, hjust=0)) # Fenología del girasol r5 = c(as.Date(&quot;2018-12-15&quot;), as.Date(&quot;2019-01-15&quot;)); diff(r5) r6 = c(as.Date(&quot;2019-01-15&quot;), as.Date(&quot;2019-03-10&quot;)); diff(r6) midpoint &lt;- function(interval) { min(interval)+(max(interval)-min(interval))/2 }; midpoint(r5) (p_final &lt;- # Agregar fenología y anotaciones varias p2 + # barras de floración y llenado annotate(&quot;rect&quot;, xmin= c(min(r5), min(r6)), xmax=c(max(r5),max(r6)), ymin=0, ymax=30, alpha=0.2, fill=c(&quot;grey80&quot;,&quot;grey60&quot;))+ annotate(&quot;text&quot;, x = c(midpoint(r5), midpoint(r6)), y=3,col=&quot;red&quot;, parse=TRUE, size=3, label=c(&#39;bold(&quot;Floración&quot;)&#39;,&#39;bold(&quot;Llenado&quot;)&#39;)) + labs(x=NULL, y=NULL, title = &quot;Temperatura media diaria en Balcarce y estadíos reproductivos del girasol&quot;, subtitle = &quot;- Campaña 2018/19 (línea negra)\\n- Serie 1971-2017: rango 80% (banda interna) y medias extremas (bandas externas)&quot;, caption = &quot;Datos registrados en la estación meteorológica de la EEA INTA Balcarce&quot;)) "]]
