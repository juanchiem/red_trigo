# Condiciones meteorológicas 

## Precipitaciones 

```{r}
pacman::p_load(tidyverse, lubridate)
load("data/nova_trigo.Rdata")
source(here::here('0 themes.R'))
```

### Cálculos resumen y visualización gráfica de las precipitaciones acumuladas por década 

1- Importar datos y agregar algunas columnas de fechas

```{r}
serie <- serie %>% 
  mutate(year = lubridate::year(date),
         month = lubridate::month(date),
         julian = lubridate::yday(date))
```

2 - Calcular lluvias acumuladas por década

```{r}
serie20 <- serie %>%
  filter(year!=2020) %>%
  group_by(date=if_else(day(date) >= 30,
                        floor_date(date, "20 days"),
                        floor_date(date, "10 days"))) %>%
  summarize(rain_acum = sum(rain),
            days = n()) %>%
  mutate(year = year(date),
         month = month(date)) %>%
  ungroup %>%
  group_by(year) %>%
  mutate(decada = row_number()) %>%
  ungroup %>%
  group_by(decada) %>%
  summarise(month = first(month),
            med = quantile(rain_acum, .5, na.rm = T),
            lower_80=quantile(rain_acum, .2, na.rm = T), # Rango 80% de los años
            upper_80=quantile(rain_acum, .8, na.rm = T)) 
serie20

```

```{r}
c2020 <- # Para la reciente campaña
  serie %>%
  group_by(date = if_else(day(date) >= 30,
                          floor_date(date, "20 days"),
                          floor_date(date, "10 days"))) %>%
  summarize(rain_acum_season = sum(rain)) %>% #, days=n()) %>%
  mutate(year = year(date),
         month = month(date)) %>%
  group_by(year) %>%
  mutate(decada = row_number()) %>%
  filter(date > '2020-05-01', date < '2020-12-31') %>% 
  left_join(serie20, by = c("decada")) %>%
  mutate(date = as.Date(date))
 # fusionar ambos datasets (serie + campaña)

```

3 - Visualizar la serie y sus bandas de 80-percentil, y valores acumulados por década de la última campaña

```{r}
c2020 %>%
    ggplot(aes(x=date)) +
    geom_pointrange(aes(y=med, ymin=lower_80, ymax=upper_80), fill='white', color='deepskyblue',
                    shape=21, fatten=.7, size=3, position=(p5=position_nudge(x = 5)))+
    geom_point(aes(y=rain_acum_season), col ="brown1",
               position=p5) +
    geom_line(aes(y=rain_acum_season, group=1), col ="brown1", linetype="dashed", position=p5)+
    # scale_y_continuous(limits=c(0, 100), expand=c(0.05, 0))+
    scale_x_date(date_breaks="1 month", date_labels="%b", expand=expansion(0.05,0))+
    labs(x=NULL, y=NULL,
         title = "Precipitaciones decádicas en Balcarce",
         subtitle = "- Campaña 2020 (en puntos rojos)\n- Serie 2000-2019: mediana (puntos blancos) y rango 80% (barras azules)",
         # "mm acumulados por períodos de 10 días",
         caption = "Datos registrados en la estación meteorológica de la EEA INTA Balcarce")

# serie %>%
#   filter(year <2020) %>% 
#   group_by(year) %>% 
#   summarise(cs = cumsum(rain))

c2020 %>% 
  mutate_at(vars(month.y), as.factor)%>% 
  ungroup() %>% 
  group_by(month.y) %>% 
  summarise(
    cs = sum(rain_acum_season),
    cs_med = sum(med), 
    bal = cs - cs_med)
```

> agosto, septiembre noviembre y diciembre llovio menos que lo normal 2020-2019

```{r}
# 5 - Fenología del cultivo
# z39 = c(as.Date("2018-12-15"),  as.Date("2019-01-15")); diff(r5)
# r6 = c(as.Date("2019-01-15"),  as.Date("2019-03-10")); diff(r6)
# midpoint <- function(interval) { min(interval)+(max(interval)-min(interval))/2 }; midpoint(r5)

```

```{r}
# (p_final <- # Agregar fenología y anotaciones varias
#     p1 +
#     # Polígonos de floracion y llenado
#     annotate("rect", xmin= c(min(r5), min(r6)), xmax=c(max(r5),max(r6)), ymin=70, ymax=90, alpha=0.3, fill=c("grey80","grey60"))+
#     annotate("text", x = c(midpoint(r5), midpoint(r6)), y=80,col="red", parse=TRUE, size=3,
#              label=c('bold("Floración")','bold("Llenado")')) +
#     labs(x=NULL, y=NULL,
#          title = "Precipitaciones decádicas en Balcarce y estadíos reproductivos del girasol",
#          subtitle = "- Campaña 2018/19 (en puntos rojos)\n- Serie 1971-2017: mediana (puntos blancos) y rango 80% (barras azules)",
#          # "mm acumulados por períodos de 10 días",
#          caption = "Datos registrados en la estación meteorológica de la EEA INTA Balcarce")
# )
# ggsave(file = "plots/bce_lluvias.png", w=80, h=50, units="mm", dpi=300, scale=2) 
```


## Temperaturas


### Calcular 80-percentil de Tmean diarias y valores maximos y minimos observados en la serie  histórica

```{r}
bce_serie <-
  serie %>% 
  filter(year!=2020) %>%
  group_by(julian) %>%
  summarise(
    month = first(month),
    avg = mean(tmean, .2, na.rm = T),
    # Rango 80% de los años (rango interno)
    lower_80=quantile(tmean, .2, na.rm = T),
    upper_80=quantile(tmean, .8, na.rm = T),
    # Min y max de tmean (rango externo)
    lower_tmean=min(tmean, na.rm = T),
    upper_tmean=max(tmean, na.rm = T)) %>%
  ungroup()

```

```{r}
camp <- # Fusionar serie con campaña 18/19
  serie %>%
  filter(date > '2020-05-01', date < '2020-12-30') %>%
  left_join(bce_serie, by = c("julian", "month")) %>%
  mutate(date = as.Date(date)) %>%
  droplevels()

camp %>% 
  group_by(month) %>% 
  summarize(n_days = n(),
            d_frios = sum(tmean < avg),
            p_frios = d_frios / n_days,
            d_calidos = sum(tmean > avg),
            p_calidos = d_calidos / n_days
            )
```


```{r}
camp %>% 
  ggplot(aes(date, avg)) +  
  geom_ribbon(aes(ymin = tmean, ymax = pmin(tmean, avg), fill = "cálido"),alpha=0.5 ) +
  geom_ribbon(aes(ymin = avg, ymax = pmin(tmean, avg), fill = "frío"), alpha=0.5) +
  geom_line(aes(date, avg, linetype = "media 2000-2019 ")) +
  geom_line(aes(date, tmean, linetype = "campaña 2020")) +
  scale_fill_brewer(palette = "Set1", direction = 1)+
  scale_x_date(date_breaks="1 month", date_labels="%b", expand=expansion(0.01,0))+
  labs(fill="", linetype="", x ="", y ="T°")+
  theme_dens
```

```{r eval = F}
rec_frio <- camp[which(camp$tmean<camp$lower_tmean),]
rec_cal <- camp[which(camp$tmean>camp$upper_tmean),]

library(ggrepel); options(repr.plot.width = 2, repr.plot.height = 2)


p2 <- p1 +
  # Agregar medias record frío
  geom_point(data = rec_frio, aes(date, y = tmean), colour = "blue") +
  geom_text_repel(data=rec_frio[1,], aes(y=tmean, label="Récord fríos"), size=3,
                  min.segment.length = unit(0, 'lines'), nudge_y = -2, segment.color="grey50")+
  # Agregar medias record cálido
  geom_point(data =rec_cal, aes(date, y=tmean), col="red")+
  geom_text_repel(data = rec_cal, aes(y=tmean, label="Récord cálido"), size=3,
                  min.segment.length = unit(0, 'lines'), nudge_y=2, segment.color="grey50")+
  # Agregar heladas meteorologicas y agronomicas
  geom_point(data = camp[which(camp$tmin<1),],
             aes(date, y=0), shape=8, col="blue") +
  geom_point(data = camp[which(camp$tmin>0 & camp$tmin<3.6),],
             aes(date, y=3.5), shape=8, col="chartreuse")#+
p2
# annotate("text", x=-Inf, y=c(0,3.5),
  #          label=c("Helada meteorológica","Heladas\nagronómicas"), size=3, hjust=0))
```

```{r, eval = F}
# Fenología del girasol
r5 = c(as.Date("2018-12-15"),  as.Date("2019-01-15")); diff(r5)
r6 = c(as.Date("2019-01-15"),  as.Date("2019-03-10")); diff(r6)
midpoint <- function(interval) { min(interval)+(max(interval)-min(interval))/2 }; midpoint(r5)

(p_final <- # Agregar fenología y anotaciones varias
    p2 +
    # barras de floración y llenado
    annotate("rect", xmin= c(min(r5), min(r6)), xmax=c(max(r5),max(r6)), ymin=0, ymax=30, alpha=0.2, fill=c("grey80","grey60"))+
    annotate("text", x = c(midpoint(r5), midpoint(r6)), y=3,col="red", parse=TRUE, size=3,
             label=c('bold("Floración")','bold("Llenado")')) +
    labs(x=NULL, y=NULL,
         title = "Temperatura media diaria en Balcarce y estadíos reproductivos del girasol",
         subtitle = "- Campaña 2018/19 (línea negra)\n- Serie 1971-2017: rango 80% (banda interna) y medias extremas (bandas externas)",
         caption = "Datos registrados en la estación meteorológica de la EEA INTA Balcarce"))

```

